<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">Clase - ACADEMIA DE LA POLIS</title>
    <link rel="stylesheet" href="../css/styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #fce4ec 0%, white 100%);
            min-height: 100vh;
        }

        .class-header {
            background: var(--gradient);
            color: white;
            padding: 2rem 0;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .class-header .container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 2rem;
            flex-wrap: wrap;
        }

        .class-title-section {
            flex: 1;
        }

        .class-number-badge {
            display: inline-block;
            background: rgba(255,255,255,0.3);
            padding: 0.5rem 1.5rem;
            border-radius: 10px;
            font-weight: 700;
            font-size: 1rem;
            margin-bottom: 0.5rem;
        }

        .class-title {
            font-size: 2rem;
            margin: 0.5rem 0;
        }

        .class-meta-header {
            display: flex;
            gap: 2rem;
            opacity: 0.95;
            flex-wrap: wrap;
            margin-top: 0.5rem;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .back-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            padding: 0.8rem 1.5rem;
            border-radius: 10px;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .back-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: translateX(-5px);
        }

        .content-section {
            padding: 3rem 0;
        }

        .content-container {
            max-width: 900px;
            margin: 0 auto;
        }

        .welcome-card {
            background: white;
            border-radius: 20px;
            padding: 3rem;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            text-align: center;
            margin-bottom: 2rem;
        }

        .welcome-icon {
            font-size: 5rem;
            margin-bottom: 1rem;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }

        .welcome-title {
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--dark-color);
            margin-bottom: 1rem;
        }

        .welcome-subtitle {
            font-size: 1.2rem;
            color: #666;
            margin-bottom: 2rem;
            line-height: 1.8;
        }

        .start-btn {
            background: var(--gradient);
            color: white;
            border: none;
            padding: 1.5rem 3rem;
            border-radius: 15px;
            font-size: 1.3rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 1rem;
        }

        .start-btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(229, 115, 115, 0.4);
        }

        .start-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .info-card {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            margin-bottom: 2rem;
        }

        .info-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .info-content {
            color: #555;
            line-height: 1.8;
            font-size: 1.1rem;
        }

        .info-list {
            list-style: none;
            padding: 0;
            margin: 1rem 0;
        }

        .info-list li {
            padding: 0.8rem 0;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .info-list li:last-child {
            border-bottom: none;
        }

        .icon-badge {
            background: var(--gradient);
            color: white;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            flex-shrink: 0;
        }

        .timeline-card {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .timeline-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: #1976d2;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .timeline-content {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            color: #555;
            line-height: 1.8;
        }

        .warning-card {
            background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .warning-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: #f57c00;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .warning-content {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            color: #555;
            line-height: 1.8;
        }

        .class-content {
            display: none;
        }

        .class-content.active {
            display: block;
        }

        .section-block {
            background: #f8f9fa;
            padding: 2rem;
            border-radius: 15px;
            margin-bottom: 1.5rem;
        }

        .section-title {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 1rem;
        }

        .section-content {
            line-height: 1.8;
            color: #444;
        }

        .action-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 2px solid #e0e0e0;
        }

        .btn-complete {
            background: var(--gradient);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 10px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            flex: 1;
        }

        .btn-complete:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(229, 115, 115, 0.3);
        }

        .loading {
            text-align: center;
            padding: 3rem;
            font-size: 1.2rem;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="class-header">
        <div class="container">
            <div class="class-title-section">
                <div class="class-number-badge" id="class-badge">Clase 1</div>
                <h1 class="class-title" id="class-name">Cargando...</h1>
                <div class="class-meta-header">
                    <div class="meta-item">
                        <span>üìñ</span>
                        <span id="subject-name">Materia</span>
                    </div>
                    <div class="meta-item">
                        <span>üìÖ</span>
                        <span id="class-date">Fecha</span>
                    </div>
                    <div class="meta-item">
                        <span>üìä</span>
                        <span id="semester-info">Semestre 1</span>
                    </div>
                </div>
            </div>
            <a href="mis-clases.html" class="back-btn">
                ‚Üê Volver a Mis Clases
            </a>
        </div>
    </div>

    <div class="content-section">
        <div class="container">
            <div id="loading" class="loading">
                üîÑ Cargando clase...
            </div>

            <!-- Pantalla de bienvenida (antes de empezar) -->
            <div id="welcome-screen" class="content-container" style="display: none;">
                <div class="welcome-card">
                    <div class="welcome-icon">üéì</div>
                    <div class="welcome-title">¬°Bienvenido a tu Primera Clase!</div>
                    <div class="welcome-subtitle">
                        Est√°s a punto de comenzar tu viaje de aprendizaje.<br>
                        Al hacer clic en "Comenzar", se iniciar√° tu cronograma personalizado de 26 semanas.
                    </div>
                    <button class="start-btn" onclick="startClass()" id="start-btn">
                        üöÄ Comenzar Clase
                    </button>
                </div>

                <div class="info-card">
                    <div class="info-title">üìö ¬øQu√© aprender√°s en esta clase?</div>
                    <div class="info-content">
                        <p><strong id="class-description">Esta es la primera clase de tu carrera en Data Analysis.</strong></p>
                        <ul class="info-list" id="learning-objectives">
                            <li><span class="icon-badge">1</span> Conceptos fundamentales de la materia</li>
                            <li><span class="icon-badge">2</span> Herramientas y recursos necesarios</li>
                            <li><span class="icon-badge">3</span> Ejercicios pr√°cticos guiados</li>
                            <li><span class="icon-badge">4</span> Proyecto aplicado a casos reales</li>
                        </ul>
                    </div>
                </div>

                <div class="timeline-card">
                    <div class="timeline-title">‚è∞ Tu Cronograma Personalizado</div>
                    <div class="timeline-content">
                        <p><strong>Al comenzar esta clase, se generar√° tu cronograma de 26 semanas:</strong></p>
                        <ul style="margin-top: 1rem; margin-left: 1.5rem;">
                            <li>üìö <strong>Semanas 1-20:</strong> Clases regulares de todas las materias</li>
                            <li>üìù <strong>Semanas 21-22:</strong> Repaso y consolidaci√≥n</li>
                            <li>üìã <strong>Semanas 23-24:</strong> Evaluaciones finales</li>
                            <li>üèñÔ∏è <strong>Semanas 25-26:</strong> Descanso y cierre</li>
                        </ul>
                        <p style="margin-top: 1rem; color: #1976d2; font-weight: 600;">
                            üìÖ Tu fecha de inicio: <span id="start-date-display">Hoy</span>
                        </p>
                    </div>
                </div>

                <div class="warning-card">
                    <div class="warning-title">‚ö†Ô∏è Importante</div>
                    <div class="warning-content">
                        <p><strong>Una vez que comiences:</strong></p>
                        <ul style="margin-left: 1.5rem; margin-top: 0.5rem;">
                            <li>Tu cronograma se activar√° autom√°ticamente</li>
                            <li>Las clases se desbloquear√°n semanalmente</li>
                            <li>Podr√°s acceder a todas las materias del semestre</li>
                            <li>Tu progreso se guardar√° autom√°ticamente</li>
                        </ul>
                        <p style="margin-top: 1rem; font-weight: 600; color: #f57c00;">
                            üí° T√≥mate tu tiempo y aprende a tu ritmo. No hay prisa.
                        </p>
                    </div>
                </div>
            </div>

            <!-- Contenido de la clase (despu√©s de empezar) -->
            <div id="class-content" class="content-container class-content">
                <div class="info-card">
                    <div class="info-title">üéØ Contenido de la Clase</div>
                    <div class="info-content">
                        <div class="section-block">
                            <div class="section-title">üìñ Introducci√≥n</div>
                            <div class="section-content">
                                <p><strong>Bienvenido a esta clase.</strong></p>
                                <p>En esta sesi√≥n aprender√°s los conceptos fundamentales necesarios para dominar esta materia. El contenido est√° dise√±ado para que puedas aprender a tu propio ritmo.</p>
                            </div>
                        </div>

                        <div class="section-block">
                            <div class="section-title">ÔøΩ Material de Estudio</div>
                            <div class="section-content">
                                <p><strong>Contenido te√≥rico y conceptos clave:</strong></p>
                                <p>El contenido detallado de esta clase estar√° disponible pr√≥ximamente. Cada clase incluir√°:</p>
                                <ul style="margin-left: 1.5rem; margin-top: 0.5rem;">
                                    <li><strong>Teor√≠a:</strong> Explicaciones claras y concisas de los conceptos</li>
                                    <li><strong>Ejemplos:</strong> Casos pr√°cticos y aplicaciones reales</li>
                                    <li><strong>Diagramas:</strong> Visualizaciones para mejor comprensi√≥n</li>
                                    <li><strong>Res√∫menes:</strong> Puntos clave para recordar</li>
                                </ul>
                                <p style="margin-top: 1rem;">Mientras se completa el contenido, puedes:</p>
                                <ul style="margin-left: 1.5rem;">
                                    <li>Explorar recursos externos recomendados</li>
                                    <li>Revisar la documentaci√≥n oficial</li>
                                    <li>Participar en la comunidad y hacer preguntas</li>
                                    <li>Practicar con proyectos personales</li>
                                </ul>
                            </div>
                        </div>

                        <div class="section-block">
                            <div class="section-title">üí™ Ejercicios Pr√°cticos</div>
                            <div class="section-content">
                                <p><strong>Aplica lo aprendido:</strong></p>
                                <p>Los ejercicios pr√°cticos estar√°n disponibles pr√≥ximamente. Incluir√°n:</p>
                                <ul style="margin-left: 1.5rem; margin-top: 0.5rem;">
                                    <li>Ejercicios guiados paso a paso</li>
                                    <li>Desaf√≠os de dificultad progresiva</li>
                                    <li>Proyectos mini aplicados</li>
                                    <li>Soluciones y explicaciones detalladas</li>
                                </ul>
                            </div>
                        </div>

                        <div class="section-block">
                            <div class="section-title">ÔøΩ Recursos Adicionales</div>
                            <div class="section-content">
                                <p><strong>Material complementario:</strong></p>
                                <ul style="margin-left: 1.5rem;">
                                    <li>üìÑ Documentaci√≥n oficial</li>
                                    <li>üìù Cheat sheets y gu√≠as r√°pidas</li>
                                    <li>üåê Links a tutoriales externos</li>
                                    <li>üíª Repositorios de c√≥digo de ejemplo</li>
                                    <li>üìö Libros y art√≠culos recomendados</li>
                                </ul>
                                <p style="margin-top: 1rem; font-style: italic; color: #666;">
                                    Los enlaces y recursos espec√≠ficos se agregar√°n pr√≥ximamente.
                                </p>
                            </div>
                        </div>

                        <div class="section-block" style="background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); border-left: 4px solid #4caf50;">
                            <div class="section-title" style="color: #2e7d32;">üí° Consejos para Aprovechar esta Clase</div>
                            <div class="section-content">
                                <ul style="margin-left: 1.5rem;">
                                    <li><strong>Toma notas:</strong> Escribe los conceptos clave con tus propias palabras</li>
                                    <li><strong>Practica:</strong> No solo leas, aplica lo aprendido</li>
                                    <li><strong>Haz preguntas:</strong> Usa la comunidad si tienes dudas</li>
                                    <li><strong>Revisa:</strong> Repasa el material antes de avanzar</li>
                                    <li><strong>S√© constante:</strong> Dedica tiempo regular al estudio</li>
                                </ul>
                            </div>
                        </div>

                        <div class="action-buttons">
                            <button class="btn-complete" onclick="completeClass()">
                                ‚úì Marcar como Completada y Continuar
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../js/config.js"></script>
    <script src="../js/auth.js"></script>
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const classNumber = parseInt(urlParams.get('class')) || 1;
        const week = parseInt(urlParams.get('week')) || 1;
        const subjectId = urlParams.get('subject');

        let classData = null;
        let hasStarted = false;

        async function loadClass() {
            await authManager.waitForReady();

            if (!authManager.isAuthenticated()) {
                window.location.href = '../login.html';
                return;
            }

            // Verificar si el estudiante ya ha comenzado (tiene fecha de inicio registrada)
            const { data: student } = await supabase
                .from('students')
                .select('created_at, enrolled_career')
                .eq('user_id', authManager.user.id)
                .single();

            if (student) {
                const startDate = new Date(student.created_at);
                const now = new Date();
                const daysDiff = Math.floor((now - startDate) / (1000 * 60 * 60 * 24));
                
                // Si han pasado m√°s de 1 d√≠a desde la creaci√≥n, ya comenz√≥
                hasStarted = daysDiff > 0;
            }

            // Obtener datos de la clase
            classData = await getClassData(classNumber, week, subjectId);

            if (!classData) {
                alert('Clase no encontrada');
                window.location.href = 'mis-clases.html';
                return;
            }

            // Actualizar UI
            updateUI();

            document.getElementById('loading').style.display = 'none';
            
            if (classNumber === 1 && !hasStarted) {
                // Mostrar pantalla de bienvenida solo para la primera clase
                document.getElementById('welcome-screen').style.display = 'block';
            } else {
                // Mostrar contenido directo
                document.getElementById('class-content').classList.add('active');
            }
        }

        async function getClassData(classNum, weekNum, subjId) {
            // Aqu√≠ ir√≠a la l√≥gica para obtener datos de la clase
            // Por ahora, devuelvo datos de ejemplo
            const subjects = {
                'python-basics': { name: 'Python B√°sico', hours: 40 },
                'data-structures': { name: 'Estructuras de Datos', hours: 35 },
                'algorithms': { name: 'Algoritmos', hours: 30 },
                'git-github': { name: 'Git & GitHub', hours: 20 },
                'linux-basics': { name: 'Linux B√°sico', hours: 25 },
                'sql-fundamentals': { name: 'SQL Fundamentos', hours: 30 },
                'statistics-1': { name: 'Estad√≠stica I', hours: 35 }
            };

            const subject = subjects[subjId] || { name: 'Materia Desconocida', hours: 30 };

            // Calcular fecha de la clase
            const { data: student } = await supabase
                .from('students')
                .select('created_at')
                .eq('user_id', authManager.user.id)
                .single();

            const startDate = student ? new Date(student.created_at) : new Date();
            const classDate = new Date(startDate);
            classDate.setDate(classDate.getDate() + ((weekNum - 1) * 7));

            return {
                classNumber: classNum,
                week: weekNum,
                subjectId: subjId,
                subjectName: subject.name,
                hours: subject.hours,
                date: classDate,
                semester: 1
            };
        }

        function updateUI() {
            document.getElementById('class-badge').textContent = `Clase ${classData.classNumber}`;
            document.getElementById('class-name').textContent = classData.subjectName;
            document.getElementById('page-title').textContent = `Clase ${classData.classNumber}: ${classData.subjectName} - ACADEMIA DE LA POLIS`;
            document.getElementById('subject-name').textContent = classData.subjectName;
            document.getElementById('class-date').textContent = formatDate(classData.date);
            document.getElementById('semester-info').textContent = `Semestre ${classData.semester} ‚Ä¢ Semana ${classData.week}`;
            
            if (document.getElementById('class-description')) {
                document.getElementById('class-description').textContent = 
                    `Esta es la clase ${classData.classNumber} de ${classData.subjectName}.`;
            }

            if (document.getElementById('start-date-display')) {
                document.getElementById('start-date-display').textContent = formatDate(classData.date);
            }
        }

        async function startClass() {
            const btn = document.getElementById('start-btn');
            btn.disabled = true;
            btn.innerHTML = '‚è≥ Iniciando...';

            try {
                // Registrar el inicio en la base de datos
                // Esto ya se hace autom√°ticamente al crear el estudiante
                // Pero podr√≠amos agregar un campo espec√≠fico para el inicio del cronograma

                // Esperar un momento para efecto visual
                await new Promise(resolve => setTimeout(resolve, 1000));

                // Ocultar bienvenida y mostrar contenido
                document.getElementById('welcome-screen').style.display = 'none';
                document.getElementById('class-content').classList.add('active');

                // Registrar actividad
                await authManager.recordDailyActivity();

                authManager.showNotification(
                    'üéâ ¬°Cronograma Activado!\n\nTu plan de 26 semanas ha comenzado. Las clases se desbloquear√°n semanalmente.',
                    'success'
                );
            } catch (error) {
                console.error('Error al iniciar:', error);
                btn.disabled = false;
                btn.innerHTML = 'üöÄ Comenzar Clase';
                authManager.showNotification('Error al iniciar la clase. Intenta nuevamente.', 'error');
            }
        }

        async function completeClass() {
            try {
                // Registrar completaci√≥n de la lecci√≥n
                await authManager.completeLesson(
                    classData.subjectId,
                    classData.subjectName,
                    30 // minutos
                );

                authManager.showNotification(
                    `‚úÖ Clase ${classData.classNumber} completada\n\n+50 XP ganados\n+5% progreso en ${classData.subjectName}`,
                    'success'
                );

                // Volver a mis clases despu√©s de 2 segundos
                setTimeout(() => {
                    window.location.href = 'mis-clases.html';
                }, 2000);
            } catch (error) {
                console.error('Error al completar clase:', error);
                authManager.showNotification('Error al completar la clase. Intenta nuevamente.', 'error');
            }
        }

        function formatDate(date) {
            const options = { day: 'numeric', month: 'long', year: 'numeric' };
            return date.toLocaleDateString('es-ES', options);
        }

        window.addEventListener('DOMContentLoaded', loadClass);
    </script>
</body>
</html>
